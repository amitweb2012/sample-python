name: my-first-workflow

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main

permissions:
  contents: read
  security-events: write
  actions: read
  packages: write

jobs:
  ci-pipeline:
    uses: amitweb2012/Github-Action-Reusable-Workflow/.github/workflows/ci-pipeline.yml@main

    with:
      codeql: true
      sonarqube: false
      build: false

    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}

  deploy:
    name: Deploy to Minikube
    runs-on: [self-hosted, minikube] # ğŸ”¥ IMPORTANT
    needs: ci-pipeline
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ğŸ” Verify runner
      - name: Check runner
        run: |
          echo "Running on self-hosted runner"
          uname -a

      # ğŸ” Verify Kubernetes
      - name: Check Kubernetes
        run: kubectl get nodes

      # ğŸ³ Build image locally (Minikube Docker)
      - name: Use Minikube Docker
        run: |
          eval $(minikube docker-env)

      - name: Build Docker Image
        run: |
          docker build -t python-calculator:latest .

      # ğŸš€ Deploy to Kubernetes
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/deployment.yml
          kubectl apply -f k8s/service.yml

      # ğŸ” Verify deployment
      - name: Check pods
        run: kubectl get pods

      - name: Check service
        run: kubectl get svc
